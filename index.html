<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--  JQUERY -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  
    <!-- LEAFLET-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>


    <title>CV interactive map</title>

    <style>
      html,
      body {
          min-height: 100%;
          -webkit-background-size: cover;
          -moz-background-size: cover;
          -o-background-size: cover;
          background-size: cover;
          background-repeat: no-repeat;
          background-image: linear-gradient(rgb(255,255,255), rgb(255, 255, 255));
      }

  </style>
</head>
<body>

    <div class="container-fluid">

            <div class="container-fluid">
                    <div id="cvmap" style="height: 700px; position: relative; outline: none;">

                    </div>

            </div>

        
    </div>
    <script>  
       /* globals L, location */

       var CVmap = L.map('cvmap').setView([1.80, 0.98], 9);
      /* Load the tileLayer x and y*/
      L.tileLayer(`https://map.cryptovoxels.com/tile?z={z}&x={x}&y={y}`, {
        minZoom: 3,
        maxZoom: 20,
        attribution: 'Map data &copy; Cryptovoxels',
        id: 'cryptovoxels'
      }).addTo(CVmap)

      var ocmIcon = L.icon({
          iconUrl: 'OCM_marker.png',
          shadowUrl: 'OCM_marker_shad.png',

          iconSize:     [38, 95], // size of the icon
          shadowSize:   [50, 64], // size of the shadow
          iconAnchor:   [15, 2], // point of the icon which will correspond to marker's location
          shadowAnchor: [3, 15],  // the same for the shadow
      });
      L.marker([1.80, 0.98], {icon: ocmIcon}).addTo(CVmap);

      var popupWindow = L.popup() /* create popup object */

      function getCoordinates (geoX, geoY) {
        const coordinates = []
          //Checking if geoX is null else if negative -> West, if positive -> Est
        if (geoX === 0) {geoX = null} else {
          coordinates.push(geoX < 0 ? Math.abs(geoX) + 'W' : geoX + 'E')
        }

          //Checking if geoY is null and else if negative -> South, if positive -> North
        if (geoY === 0) {geoY = null} else {
          coordinates.push(geoY < 0 ? Math.abs(geoY) + 'S' : geoY + 'N')
        }
        //Checking if Coordinates are different than 0, and else send the location to the GET url
        if(coordinates.length ===0){
          return '/'
        }else{
          '/?coords=' + coordinates.join(',')
        }
        
      }

      function onMapClick (e) {

        // Transform the latitude and longitude of the map to geoX and geoY
        let geoX = Math.round(100*e.latlng.lng )
        let geoY = Math.round(100*e.latlng.lat )

        
        const playCoord = getCoordinates(geoX, geoY)// Get the URL from previous function

        popupWindow
          .setLatLng(e.latlng)// Set content of the popup Object
          .setContent(`
          <iframe id="cryptovoxel" src="https://www.cryptovoxels.com/play${playCoord}&mode=orbit" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:15rem; height:100%; min-height:10rem;" allowTransparency="true" sandbox="allow-scripts allow-same-origin">
          `)
          .openOn(CVmap)
        // Here the content is orbit mode (&mode=obrit) For more information on the flags you want go to https://www.cryptovoxels.com/docs/flags
      }
      popupWindow.on('popupclose',e=>{
        $('#cvmap').find('iframe').attr('src',"")// Cleaning up the popup content to avoid having multiple Cryptovoxels processes
    })
      CVmap.on('click', onMapClick)// Listen to clicks
    </script>
    </body>

    <!--/container-->

